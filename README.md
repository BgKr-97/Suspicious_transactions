# Разработка системы выявления подозрительных транзакций для банка

## Содержание
Описание проекта
Стек
Структура проекта
Системный анализ
Установка и настройка
Функциональность
Визуализация
Цели проекта

## Описание проекта

Данный проект представляет собой прототип системы автоматического выявления подозрительных финансовых транзакций, ориентированной на задачи внутреннего комплаенс-мониторинга в банке или финансовой организации.

Система предназначена для:

- Раннего выявления аномальной активности клиентов на основании анализа транзакционных данных.

- Присвоения каждой транзакции скорингового риска на основе настраиваемых критериев.

- Формирования витрины данных для последующего анализа и визуализации ключевых показателей в BI-инструменте.

Проект построен по архитектуре DWH (Data Warehouse) с полной ETL-цепочкой, позволяет обрабатывать, хранить и визуализировать данные, а также легко адаптироваться под изменение правил комплаенса и бизнес-логики.

Основная задача — создать масштабируемую, расширяемую систему, способную:

- Сократить время, необходимое на ручную проверку транзакций сотрудниками службы безопасности.

- Уменьшить количество ложноположительных срабатываний за счёт более точных и прозрачных правил.

- Повысить эффективность процедур, направленных на борьбу с отмыванием денег (AML) и соблюдение регуляторных требований.

- Обеспечить основу для внедрения машинного обучения на следующем этапе развития системы.

## Рабочий процесс

Ниже представлена BPMN-диаграмма, иллюстрирующая работу логики ETL:
<img width="8925" height="7084" alt="bpmn_etl-process" src="https://github.com/user-attachments/assets/f92e9afe-6d06-4249-8469-9559c7ed4415" />

## 1. Архитектура хранилища
- Источники данных – база данных банка, открытые базы данных сторонних сервисов.
- Слой сырых данных – данные перенесенные из источников данных (в исходном состоянии).
- DWH – база данных, состоящая из ядра и витрины данных. Витрина хранит агрегированные данные, готовые для использования в BI.
- Дашборд - интерактивная визуализация данных.

![system_arc](https://github.com/user-attachments/assets/fbc7a2ef-b5be-4660-9dd5-9a09fdc08447)

_Архитектура ИС: от базы данных до BI-витрины_

## 2. База данных банка

Внутренняя инфраструктура заказчика, используемая в качестве источника данных.

Логическая модель:

<img width="488" height="289" alt="er_bank" src="https://github.com/user-attachments/assets/e35d6b2c-811e-44b8-94b5-72d5af6ad223" />

## 3. Слой staging

Слой сырых данных - данные, перенесенные из источников данных (в исходном состоянии).

Логическая модель:

<img width="482" height="236" alt="er_stg" src="https://github.com/user-attachments/assets/53e877ce-8b0c-4178-92cb-bdf11ece29f3" />

## 4. Слой core

Ядро - хранит очищенные и обогащенные данные.

Логическая модель:

<img width="468" height="285" alt="er_core" src="https://github.com/user-attachments/assets/70ae3642-924f-4cde-9d5c-1d36c6609763" />

## 5. Слой data_mart

Витрина хранит агрегаты, готовые для использования в BI.

Логическая модель:

<img width="134" height="297" alt="er_mart" src="https://github.com/user-attachments/assets/15875aa7-8bc9-45d0-81d1-3e7a54a7fb45" />

## Используемый стек

### Бэкенд

- Python 3.12+
- PostgreSQL
- Docker

### Библиотеки

- SQLAlchemy
- psycopg2
- pandas
- numpy
- argparse
- python-dotenv
- logging
- faker


### Инструменты

- Yandex DataLens (для визуализации)

## Структура проекта

```
├── docs/                       # Документация проекта
├── etl/                        # ETL-логика
│   ├── config/                 # Конфиги логирования
│   ├── Database/
│   │   ├── json/               # JSON-правила оценки риска
│   │   └── sql/                # SQL-скрипты создания и загрузки
│   ├── Models/                 # Модель для скоринга
│   ├── Генерация_...py         # Генерация синтетических данных
│   ├── loading_...py           # Загрузка из банка в staging
│   └── add_from_...py          # Загрузка из staging в core
├── src/
│   ├── gifs/                   # Гифки визуализаций
│   └── pictures/               # ER-диаграммы
├── .env                        # Файл окружения с параметрами
├── main.py                     # Главный скрипт — ETL + скоринг
├── database.py                 # Работа с PostgreSQL (extract/load)
├── risk_model.py               # Класс скоринга транзакций
├── requirements.txt            # Зависимости проекта
└── README.md                   # Описание проекта
```

## Системный анализ

### 1. Операционная среда

- ОС-1: Система должна корректно работать с десктопными версиями основных браузеров, таких как Google Chrome, Apple Safari и другие.
- ОС-2: DWH размещено на сервере под управлением последних версий Red Hat Linux и Apache HTTP Server.

### 2. Ограничения проектирования и реализации

- Огр-1: Веб-приложение должно использовать последнюю версию СУБД PostgreSQL.
- Огр-2: ETL-процессы должны быть реализованы с использованием библиотеки Python (pandas).
- Огр-3: Информация по подозрительным транзакциям должна отображаться на BI-дашборде.

### 3. Риски и допущения

Основные риски проекта

| Риск                                                 | Вероятность   | Влияние на проект |
| ---------------------------------------------------- | ------------- | ----------------- |
| Недостаточная производительность системы             | Средняя       | Низкое            |
| Проблемы с безопасностью данных                      | Средняя       | Низкое            |
| Изменение требований заказчика                       | Высокая       | Высокое           |
| Конфликты между стейкхолдерами                       | Средняя       | Среднее           |  
| Изменения на рынке (экономические кризисы, санкции)  | Высокая       | Высокое           |


**Меры по снижению рисков**

- Проведение нагрузочного тестирования и оптимизация запросов к базе данных.
- Регулярные аудиты безопасности.
- Использование Agile-методологии с короткими итерациями и регулярными демонстрациями заказчику.
- Приоритезация требований и управление конфликтами между стейкхолдерами.
- Мониторинг экономической ситуации и поиск альтернативных рынков.

**Допущения**

- Интеграция с существующими банковскими информационными системами.
- Возможность доработки алгоритма выявления подозрительных транзакций по мере необходимости.
- Использование согласованных с заинтересованными сторонами данных.
- Соблюдение всех юридических и нормативных требований по защите данных (включая AML/CFT).

### 4. Требования к бизнес-задаче

**Бизнес-требования**

- БТ1. Разработать алгоритм для обнаружения подозрительных транзакций на основе заданных критериев.

**Бизнес-правила**

- БП1. Банковские операции на сумму более 100 000 рублей являются метрикой подозрительности.
- БП2. Банковские операции в ночное время (с 00:00 до 06:00) являются метрикой подозрительности.
- БП3. Резкое изменение геолокации (аномалии в перемещении клиента на расстояние более 500 км) является метрикой подозрительности.
- БП4. Увеличение числа транзакций (если клиент совершает более 7 транзакций за последние 2 часа) является метрикой подозрительности.
- БП5. Несколько попыток переводов денежных средств малыми (несколько транзакций в течение 1 часа от 1000 рублей, сумма транзакций 20 000) являются метрикой подозрительности.
- БП6. Неопознанные категории перевода являются метрикой подозрительности.
- БП7. Переводы в "рискованные" страны являются метрикой подозрительности.
- БП8. Если возраст клиента более 60 лет — это является метрикой подозрительности.
- БП9. Пользователь с ролью "Руководитель" имеет доступ к персональным данным клиента банка, пользователь с ролью "Сотрудник" такого доступа не имеет.
- БП10. Система должна соответствовать стандартам безопасности данных, принятым в банковской отрасли. Все данные, передаваемые и хранимые в системе, должны быть защищены с использованием шифрования и других современных технологий защиты (GDPR, PCI DSS).

**Пользовательские требования**

- ПТ1. Информация о подозрительных транзакциях должна выводиться на веб-дашборд.
- ПТ2. На дашборде должна выводиться таблица с подозрительными операциями (фильтры: дата, сумма, тип, статус) с полями: Номер транзакции, Клиент (ID/имя), Сумма и валюта, Дата и время, Категория операции, Статус (новые, проверенные, подтверждённые как мошенничество).
- ПТ3. На дашборде должна выводиться оценка риска каждой транзакции.
- ПТ4. На дашборде должны выводиться причины подозрительности транзакции (например, список: "Необычное место", "Высокая сумма").
- ПТ5. На дашборде должно быть несколько слоев (многоуровневый интерфейс).
- ПТ6. На дашборде работают пользователи с разными ролями: "Сотрудник", "Руководитель".
- ПТ7. На дашборде должно выводиться количество транзакций за период (день/неделя/месяц).
- ПТ8. На дашборде должно выводиться количество подозрительных транзакций в динамике.
- ПТ9. На дашборде должна выводиться доля подозрительных операций.
- ПТ10. На дашборде должна выводиться сумма подозрительных транзакций в рублях и в % от общего объема.
- ПТ11. На дашборде должна выводиться таблица с подозрительными операциями, включая информацию по регионам.
- ПТ12. На дашборде должны выводиться топ-5 подозрительных категорий (по количеству и сумме).
- ПТ13. На дашборде должна выводиться география транзакций (карта с аномальными операциями).
- ПТ14. На дашборде должны выводиться временные аномалии (график по часам/дням).
- ПТ15. На дашборде должна быть возможность экспорта данных в таблицу Excel.

### 5. Функциональные требования

**Обнаружение подозрительных транзакций**

- ФТ1.1 Система должна анализировать метрики транзакции и помечать их, если они считаются подозрительными:
  - Сумма транзакции превышает 100 000 рублей (БП1).
  - Транзакция совершена в ночное время (00:00–06:00) (БП2).
  - Обнаружено резкое изменение геолокации (перемещение клиента на >500 км между транзакциями) (БП3).
  - Клиент совершил более 7 транзакций за последние 2 часа (БП4).
  - Обнаружены множественные малые переводы (несколько транзакций в течение 1 часа от 1000 рублей, общая сумма ≥20 000 рублей) (БП5).
  - Указана неопознанная категория перевода (БП6).
  - Перевод направлен в "рискованные" страны (БП7).
  - Возраст клиента более 60 лет (БП8).


- ФТ1.2 Система должна присваивать уровень риска каждой подозрительной транзакции (низкий, средний, высокий) на основе количества и критичности сработавших метрик.

- ФТ1.3 Система должна вести журнал подозрительных операций с возможностью последующего анализа.

**Дашборд и визуализация данных**

- ФТ2.1 Система должна предоставлять веб-дашборд с таблицей подозрительных транзакций, включающей поля:
  - Номер транзакции
  - Клиент (ID/имя)
  - Сумма
  - Дата и время
  - Категория операции
  - Статус (новая, проверенная, подтверждённая как мошенничество)


- ФТ2.2 Дашборд должен поддерживать фильтрацию по:

  - Дате
  - Сумме
  - Типу операции
  - Статусу подозрительности
  - Категориям операций
  - Регионам
 

- ФТ2.3 Дашборд должен отображать:

  - Оценку риска для каждой транзакции (ФТ1.2).
  - Причины подозрительности (список сработавших метрик).
  - Количество транзакций за выбранный период (день/неделя/месяц).
  - Динамику подозрительных транзакций (график).
  - Долю подозрительных операций в % от общего числа.
  - Сумму подозрительных транзакций в рублях и % от общего объема.
  - Топ-5 подозрительных категорий (по количеству и сумме).
  - Географию транзакций (карта с аномалиями).
  - Временные аномалии (график активности по часам/дням).
 

- ФТ2.4 Дашборд должен поддерживать экспорт данных в Excel, CSV.

**Управление доступом**

- ФТ3.1 Система должна разграничивать доступ в зависимости от ролей:

  - Руководитель – имеет доступ к персональным данным клиентов.
  - Сотрудник – не имеет доступа к персональным данным (БП9).


- ФТ3.2 Система должна поддерживать настройку ролей и прав.

**Безопасность данных**

- ФТ4.1 Система должна шифровать передаваемые и хранимые данные в соответствии с GDPR и PCI DSS (БП10).


**Интеграция и ограничения**

- ФТ5.1 Система должна интегрироваться с внутренними банковскими системами без существенных изменений в архитектуре.


### 6. Нефункциональные требования

**Производительность**

- Время отклика: загрузка дашборда с фильтрами — не более 2 секунд при 1000+ транзакциях.
- Пропускная способность: обработка до 5 000 транзакций в секунду в пиковых нагрузках.

**Безопасность**

- Аутентификация и авторизация: обязательная двухфакторная аутентификация (2FA) для ролей "Руководитель", автоматический выход после 15 минут неактивности.
- Криптографическая защита данных: генерация ключей по PBKDF2 (ГОСТ Р 50.1.111-2016), шифрование по PBES2 на базе ГОСТ 28147-89, контроль целостности по PBMAC1 (HMAC_GOSTR3411).
- Защита персональных данных: доступ к данным только для пользователей с соответствующими правами.
- Соответствие стандартам: PCI DSS для финансовых операций, ФЗ-152 при работе в РФ.
- Аудит доступа: логирование всех операций, связанных с персональными данными.
- Мониторинг безопасности: фиксация несанкционированных попыток доступа, отчёты о действиях пользователей с повышенными правами.

**Масштабируемость**

- Горизонтальное масштабирование: возможность добавления серверов обработки транзакций.
- Нагрузка: поддержка до 1000 транзакций в день с возможностью увеличить в 5 раз; стабильная работа при 50+ параллельных пользователях.
- Геораспределение: размещение серверов в двух дата-центрах, репликация данных между регионами (для международных банков).

**Доступность и надежность**

- Uptime ≥ 99.9% (не более 8 часов простоя в год).
- Плановое обслуживание не чаще 1 раза в месяц с уведомлением за 72 часа.
- Время восстановления: критические инциденты — не более 15 минут, некритические — до 1 часа.
- Ежедневные проверки целостности базы данных.


### 7. Основные варианты использования (Use Case)

| Use Case ID | Название                           | Акторы               | Краткое описание                                                                |
|-------------|------------------------------------|----------------------|---------------------------------------------------------------------------------|
| UC-1        | Обновление данных через ETL-скрипт | Администратор        | Запуск скрипта для обновления данных из источников в DWH и витрины данных.      |
| UC-2        | Авторизация в системе              | Начальник, Сотрудник | Вход в веб-приложение дашборда с проверкой учетных данных.                      |
| UC-3        | Обновление данных на дашборде      | Начальник, Сотрудник | Обновление датасетов дашборда с синхронизацией с базой данных.                  |
| UC-4        | Открыть дашборд                    | Начальник, Сотрудник | Просмотр визуализации данных в дашборде.                                        |
| UC-5        | Просмотр общей статистики          | Начальник, Сотрудник | Анализ общей статистики подозрительных транзакций с применением фильтров.       |
| UC-6        | Просмотр сводной информации        | Начальник, Сотрудник | Геоаналитика, тепловые карты, топ категорий подозрительных транзакций.          |
| UC-7        | Просмотр детализации транзакций    | Начальник, Сотрудник | Табличный просмотр и экспорт деталей подозрительных транзакций.                 |
| UC-8        | Просмотр причин подозрительности   | Начальник, Сотрудник | Анализ причин подозрительности с визуализациями и возможностью экспорта отчетов.|


**Use Case UC-5: Просмотр общей статистики подозрительных транзакций**

**Акторы:** Начальник, Сотрудник

**Цель:** Пользователь получает доступ к общей статистике подозрительных транзакций с возможностью применения фильтров по различным параметрам.

**Предусловия:**

- Пользователь успешно прошёл авторизацию в системе.
- Данные по подозрительным транзакциям актуальны и загружены в DWH.

**Основной поток:**

1. Пользователь открывает веб-доступ к дашборду.
2. Система отображает основное окно с доступными фильтрами (период, сумма, категория и т.д.).
3. Пользователь задаёт необходимые параметры фильтрации.
4. Система обрабатывает запрос и обновляет визуализацию общей статистики.
5. Пользователь анализирует полученные данные, при необходимости экспортирует отчет в формате Excel или PDF.

**Альтернативные потоки:**

- 3а. Если пользователь задаёт фильтр с некорректными значениями — система выводит сообщение об ошибке и предлагает корректировать фильтр.
- 4а. Если данные не загружены или произошла ошибка — система выводит предупреждение и предлагает повторить попытку.

**Постусловия:**

- Пользователь получил визуализацию и/или отчет по общей статистике подозрительных транзакций.

**Исключения:**

- Сбой соединения с сервером — отображается сообщение об ошибке, пользователю предлагается повторить попытку позже.

**Примечания:**

- Время отклика при загрузке данных не должно превышать 2 секунд при объеме данных 1000+ транзакций.
- Для пользователей с ролью "Руководитель" доступна двухфакторная аутентификация.


## Роли и права доступа

### Сотрудник

- Имеет доступ только к агрегированной и обезличенной информации.
- Не видит персональных данных (ФИО, адрес, геолокация).
- Может просматривать дашборды, фильтровать, экспортировать статистику.

### Руководитель

- Имеет доступ ко всем данным, включая персональные.
- Может анализировать причины срабатывания подозрительных операций.
- Проходит двухфакторную аутентификацию (2FA).


## Установка и настройка

```
# Клонировать репозиторий
git clone <repo_url>
cd <project_directory>
```

У вас будут 7 рабочих файлов:

- ```Генерация_синтетических_файлов.py``` - файл для генерации реалистичных данных о клиентах, банковских картах, счетах, транзакциях. Также выполняется загрузка в БД банка.
- ```loading_bank_to_staging.py``` - файл для загрузки сырых данных из БД банка на слой staging.
- ```add_from_staging_to_core.py``` - этот файл для преобразования данных со слоя staging на core.
- ```main.py``` - файл, реализующий ETL логику. Выполняет трансформацию данных.
- ```database.py``` - модуль для работы с базой данных PostgreSQL. Происходит преобразования информации согласно ETL логике, агрегация и загрузка на слой data_mart.
- ```risk_model.py``` - модуль, содержащий для скоринговой модели оценки риска транзакций.
- ```risk_criteria.json``` - файл, содержащий словарь правил оценки риска транзакций.

```
# Установить зависимости
pip install -r requirements.txt
```

```
# Создать файл .env с параметрами подключения к БД
touch .env
```

```
# .env — пример конфигурации

# Путь к файлу правил скоринга
RISK_JSON=etl/Database/json/risk_criteria.json

# Подключение к БД банка
DB_NAME_BANK=bank
DB_HOST_BANK=localhost
DB_USER_BANK=your_user
DB_PASS_BANK=your_pass
DB_PORT_BANK=5432

# Подключение к DWH
DB_NAME_TRANSACTIONS=dwh_transaction
DB_HOST_TRANSACTIONS=localhost
DB_USER_TRANSACTIONS=your_user
DB_PASS_TRANSACTIONS=your_pass
DB_PORT_TRANSACTIONS=5433
DM_SHEMA_TRANSACTIONS=data_mart
DM_TABLE_TRANSACTIONS=data_table
```

Запустить скрипты SQL:

```
# создает схему `bank` и таблицы
psql -h localhost -p 5432 -U your_user -d bank -f etl/Database/sql/creating_bank_tables.sql

# создает схему `staging` и таблицы
psql -h localhost -p 5433 -U your_user -d dwh_transaction -f etl/Database/sql/creating_staging_tables.sql

# создает схему `core` и таблицы
psql -h localhost -p 5433 -U your_user -d dwh_transaction -f etl/Database/sql/creating_core_tables.sql
```

## Функциональность

### 1. Генерация данных

```Генерация_синтетических_данных.py``` - скрипт для создания реалистичных данных для загрузки в БД банка. В результате работы скрипта моделируется финансовая база данных:

**1.1. Клиенты**

- Таблица ```clients```
- Генерация 500 клиентов
- Используется библиотека ```Faker``` с русской локалью ```ru_RU```
- Фамилия, имя, отчество
- Дата рождения ( 16 - 100 лет)
- Email (с учетом транслитерации имени и фамилии)
- Контактный телефон
- ```geolocation_id``` - геолокация с точностью до населенного пункта

**1.2. Счета**

- Таблица ```accounts```
- Генерация 700 уникальных ```account_id``` и ```IBAN``` номеров
- Связь со случайными ```client_id```

**1.3. Банковские карты**

- Таблица ```cards```
- Генерация 1000 случайных ```card_id```
- Привязка к случайным счетам и клиентам
- Учитывается вероятность наличия у одного клиента нескольких карты.

**1.4. Справочник типов транзакций**

- Таблица ```transaction_types```
- Добавлено 46 категорий (оплаты, переводы, пополнения, возвраты, кэшбэк и прочее). В том числе категория "неизвестно" для корректной работы алгоритма.
- Метка ```is_receipt``` делит операции на расходы (0) и доходы (1)

**1.5. Транзакции**

- Таблица ```transactions```
- Генерация 5000 транзаций за май 2025
- Использованы клиенты, карты, счета и типы транзакций, сгенерированные ранее
- Суммы операций от 500 до 120000 руб.
- Указаны исходный и целевой ```city_id```

**1.6. Загрузка городов и стран**

- Использование .txt файла с геоданными, полученного из открытых источников
- Пометка "неблагонадежных" стран (blacklist), используя ISO-код этих стран, полученный из открытых источников.

Пример:
```
black_list_iso = ['IR','MM','BG','BF','CM','HR','KE','CD','HT','JM','ML','MZ',
                  'NA','NG','PH','SN','ZA','SS','SY','TZ','TR','VN','YE']
```

-- Присвоение клиентам исходных и целевых городов операций (Российских и зарубежных, 90% и 10% соответственно)

**1.7. Загрузка в PostgreSQL**

- Подключение через SQLAlchemy
- Загрузка в БД банка всех таблиц, созданных на предыдущих этапах

### 2. Загрузка данных из БД банка в DWH

На этом этапе задействованы скрипты, запускаемые последовательно:

- ```loading_bank_to_staging.py``` - загрузка сырых данных из БД банка в DWH на слой ```staging```
- ```add_from_staging_to_core.py``` - загрузка данных со слоя ```staging``` на слой ```core```

Доступна загрузка как отдельных сущностей (например: таблицы клиентов, карт, счетов), так и всех сразу (с использованием аргумента ```all```). Также, реализована логика инкрементальной загрузки: добавляются только записи, которых еще нет.

Ниже описан функционал файлов:

**2.1. Функции загрузки таблиц**

Каждая функция (пример: add_clients, add_cards) выполняет следующее:

- Чтение данных из соответствующей таблицы из БД банка
- Проверка существующих id, добавление только новых данных.

```
df_bank_countries = pd.read_sql_query( "SELECT * FROM bank.countries", con=engine_bank)
    
df_staging_ids = pd.read_sql_query( "SELECT country_id FROM staging.countries", con=engine_transactions)
    
id_rows_staging = df_staging_ids['id'].to_numpy()
max_staging_id = np.max(id_rows_staging)
    
df_bank_countries = df_bank_transaction_types[df_bank_transaction_types['id'] > max_staging_id].drop_duplicates()
```

- Добавления поля created_at


**2.2. Подключениек БД**

- Использование переменных окружения из ```.env```.
- Подключечение к БД с помощью ```SQLAlchemy```.

**2.3. Парсинг аргументов командной строки и управление логикой загрузки**

- Загрузка:

```
python loading_bank_to_staging.py clients       #Загрузить только клиентов
python loading_bank_to_staging.py all           #Загрузить всё
```

- Управление логикой:

```
if args.loading == 'clients':
    add_clients()
elif args.loading == 'all':
    add_countries()
    ...
    add_transactions()
```


### 3. Реализация ETL логики

Алгоритм обнаружения подозрительных транзакций анализирует метрики транзакций и помечает их, если они считаются подозрительными:

- Сумма транзакции превышает 100 000 руб.
- Транзакция совершена в ночное время (00:00–06:00).
- Обнаружено резкое изменение геолокации (перемещение клиента на > 500 км между транзакциями).
- Клиент совершил более 7 транзакций за последние 2 часа.
- Обнаружены множественные малые переводы (несколько транзакций в течение 1 часа от 1000 руб., общая сумма ≥ 20 000 руб.).
- Указана неопознанная категория перевода.
- Перевод направлен в "неблагонадежные" страны.
- Возраст клиента более 60 лет.

Алгоритм присваивает уровень риска каждой подозрительной транзакции (обычная, требует проверки, подозрительная) на основе количества и критичности сработавших метрик. Реализовано в нескольких файлах:

- ```main.py``` - Отвечает за загрузку DataFrame с транзакциями из слоя core и его обогащение дополнительными признаками с использованием вспомогательных функций.
- ```compute_age()``` - Функция добавляет к DF столбец 'client_age': возраст клиента.
- ```detect_large_amounts()``` - Признак: 'Большая сумма операции (Сумма > 100 000 руб.). Функция добавляет к DF булев столбец 'risk_big_sum': TRUE если сумма транзакции превышает 100 000 руб.
- ```detect_night_transactions()``` - Признак: 'Операции в ночное время (00:00–06:00). Функция добавляет к DF булев столбец 'risk_night_time': TRUE если транзакция проводилась в этот промежуток.
- ```detect_geolocation()``` - Признак: 'Резкое изменение геолокации (изменение > 500 км.). Функция добавляет к DF булев столбец 'risk_geolocation_change': TRUE если геопозиция совершенной транзакции по сравнению с предыдущей отличается не менее чем на 500 км. в течение 1 ч.
- ```detect_operation_rate()``` - Признак: 'Увеличение числа операций за короткое время. Функция добавляет к DF булев столбец 'oper_rate': TRUE, если за последние 120 мин. до текущей транзакции (включая её) клиент совершил более 7 транзакций.
- ```detect_small_sums()``` - Признак: 'Несколько маленьких сумм вместо одной большой. Добавляет булев столбец 'small_sum': TRUE, если за последние 60 мин. сумма мелких транзакций превысила 20 000 руб.
- ```detect_none_type()``` - Признак: 'Категория перевода (Неизвестная). Функция добавляет к DF булев столбец 'none_type': TRUE, если тип транзакции - неизвестный.


**Признаки подозрительных операций**

Оценивается каждая транзакция на основе набора признаков, каждый из которых добавляет определённое количество баллов риска. Превышение порогового значения баллов может сигнализировать о подозрительной активности.

| Критерий                                     | Баллы | Описание                                                                                                                               |
|----------------------------------------------|--------|----------------------------------------------------------------------------------------------------------------------------------------|
| Большая сумма                                | 50     | Сумма транзакции > 100 000. Высокий риск отмывания средств, обхода лимитов или мошенничества.                                        |
| Операции в ночное время                      | 50     | Временной диапазон: 00:00–06:00. Характерно для мошеннической активности.                                                             |
| Резкое изменение геолокации                  | 50     | Расстояние между текущей и предыдущей транзакцией клиента > 500 км за короткий промежуток времени (например, 1 час). Указывает на компрометацию данных. |
| Увеличение числа операций                    | 30     | Резкий всплеск активности (например, количество операций за сутки значительно превышает среднее за месяц). Может указывать на попытку быстро вывести средства. |
| Несколько маленьких сумм вместо одной большой| 30     | Серия мелких переводов (например, по 1–5 тыс.) в течение короткого времени, которые в сумме превышают пороговую сумму. Подозрение на дробление платежей. |
| Категория перевода: "Неизвестная"            | 30     | Тип транзакции не определён, отсутствует в справочнике, не имеет чёткого назначения. Может маскировать запрещённую деятельность.      |
| Переводы в рискованные страны                | 40     | Получатель находится в юрисдикции, включённой в чёрный список (например, FATF, OFAC и др.). Независимо от суммы или времени — это критический флаг. |

Некоторые характеристики клиентов усиливают общий риск транзакции, увеличивая итоговый скоринг.

| Критерий            | Баллы / Поведение             | Описание                                                                                          |
|---------------------|-------------------------------|---------------------------------------------------------------------------------------------------|
| Клиент в возрасте 60+ | +20 баллов или +10% ко всем баллам | Люди пожилого возраста чаще становятся жертвами мошенников. При наличии других признаков — повышает риск. |


**Использование**

```
df_main = ( df_transactions

        # Добавляем возраст клиентов
        .pipe(compute_age)
    
        # Добавляем колонки с приоритетными признаками
        .pipe(detect_large_amounts)
        .pipe(detect_night_transactions)
        .pipe(detect_geolocation)
    
        # Добавляем колонки с вторичными признаками
        .pipe(detect_operation_rate)
        .pipe(detect_small_sums)
        .pipe(detect_none_type))
```


- ```risk_model.py``` - Модуль, содержащий класс RiskScoringModel для скоринговой модели оценки транзакций. Загружает весовые коэффициенты из JSON-файла и рассчитывает для каждого клиента и каждой транзакции:
  - ```risk_score```: суммарный скоринговый балл.
  - ```risk_status```: статус транзакции.
  - ```reason_flags```: список причин.

Вызываемые функции:

- ```extract_feature_scores()``` - Возвращает словарь признаков в формате: { 'column': {'score': value, 'reason': feature_name}, ... }.
- ```calculate_scores()``` - Добавляет в DataFrame столбцы:
- ```risk_score```: суммарный балл по булевым столбцам.
- ```risk_status```: один из ['Обычная', 'Требует проверки', 'Подозрительная'], выбираемый по критериям.


**Использование**

```
risk_model = RiskScoringModel(RISK_JSON)
df_calculated_risks = risk_model.calculate_scores(df_main)
```


- ```database.py``` - Модуль для работы с БД. Содержит класс DBExtractor, функции которого позволяют осуществлять загрузку/выгрузку из БД и производить манипуляции с таблицами.
  - ```_load_sql()``` - Читает SQL из файла.
  - ```_fetch_df()``` - Выполняет SQL и возвращает результат в DataFrame.
  - ```create_datamart()``` - Выполняет DDL-скрипт по созданию схемы и таблицы витрины.
  - ```load_datamart()``` - Загружает финальные данные в витрину.


**Использование**

```
extractor = DBExtractor(dbname=DB_NAME, user=DB_USER, password=DB_PASS, host=DB_HOST, port=DB_PORT) #Инициализация класса.

df_transactions = extractor.fetch_merged_transactions() # Загрузка данных их схемы core и дополнение DataFrame новыми столбцами.

df_info = extractor.fetch_merged_info() # Чтение справочной информации из БД, необходимой для витрины.

extractor.create_datamart() # Создание витрины.

extractor.load_datamart(df_data_mart, DM_SHEMA, DM_TABLE) # Загрузка в витрину.
```

**Структура витрины:**

| Поле                 | Тип данных        | Описание                                              |
|----------------------|-------------------|-------------------------------------------------------|
| transaction_id       | INTEGER PRIMARY KEY | Идентификатор транзакции                             |
| client_id            | INTEGER            | Идентификатор клиента                                |
| account_id           | INTEGER            | Идентификатор счета                                  |
| client_age           | INTEGER            | Возраст клиента                                       |
| date_time            | TIMESTAMP          | Дата и время транзакции                               |
| t_type               | TEXT               | Категория операции                                    |
| is_receipt           | BOOLEAN            | Исходящая/входящая операция                           |
| sender_country       | TEXT               | Исходная страна транзакции                            |
| sender_city          | TEXT               | Исходный город транзакции                             |
| sender_region        | TEXT               | Исходный регион транзакции                            |
| sender_latitude      | NUMERIC            | Геоданные. Широта отправителя                         |
| sender_longitude     | NUMERIC            | Геоданные. Долгота отправителя                        |
| recipient_country    | TEXT               | Целевая страна транзакции                             |
| recipient_city       | TEXT               | Целевой город транзакции                              |
| recipient_region     | TEXT               | Целевой регион транзакции                             |
| recipient_latitude   | NUMERIC            | Геоданные. Широта получателя                          |
| recipient_longitude  | NUMERIC            | Геоданные. Долгота получателя                         |
| is_suspicious        | BOOLEAN            | Признак подозрительности транзакции                   |
| risk_score           | INTEGER            | Сумма баллов риска                                    |
| reason_flags         | VARCHAR            | Список причин подозрительности                        |
| risk_status          | VARCHAR            | Статус риска транзакции                               |



## Примеры визуализации

### Описание экранов и форм, макеты (wireframes), прототипы

- Экран 1: Главный дашборд
  - Шапка: Название роли (Дашборд (начальник) / Дашборд (сотрудник) ).
  - Панель вкладок: вкладка общая статистика
  - Панель селекторов: период, детализация периода, метка подозрительности, категория операции, страна.
  - Графики, таблицы, значения: общая сумма транзакций, сумма и количество транзакций в динамике.

![frame_1](https://github.com/user-attachments/assets/e990f50a-ba71-4a8c-854c-50e96ed4a1d2)


- Экран 2: Главный дашборд
  - Шапка: Название роли (Дашборд (начальник) / Дашборд (сотрудник)).
  - Панель вкладок: вкладка Анализ подозрительных транзакций
  - Панель селекторов: период, тип операций, операции в рискованных странах, категория операции, выбор единиц измерения, показать операции в промежутке, страна.
  - Графики, таблицы, значения: геоаналитика, распределение по часам, топ-10 подозрительных транзакций.

![frame_2](https://github.com/user-attachments/assets/8c34477a-4e56-4e43-b5be-dd294afaaea1)


- Экран 3: Главный дашборд
  - Шапка: Название роли (Дашборд (начальник) / Дашборд (сотрудник) ).
  - Панель вкладок: вкладка Детализация Транзакций
  - Панель селекторов: период, что выводить в таблице, анализировать показатели по, метка подозрительности, статусы риска, страна, категории.
  - Графики, таблицы, значения: таблица подозрительности транзакций с распределением

![frame_3](https://github.com/user-attachments/assets/9cd128e2-53ae-4308-b1e0-60385dfd083e)


- Экран 4: Главный дашборд
  - Шапка: Название роли (Дашборд (начальник) / Дашборд (сотрудник)).
  - Панель вкладок: вкладка Анализ причин подозрительности
  - Панель селекторов: период, метка подозрительности, категории операции, причины подозрительности, показать возраст до, страна.
  - Графики, таблицы, значения: распределение рисков по сегментам клиентов, причины подозрительности по категориям.

![frame_4](https://github.com/user-attachments/assets/6c36895f-3a98-4ead-99cf-27d1be46668d)


## Навигация и взаимодействие

Горизонтальное меню:

- Панель заголовка– указание типа дашборда
- Панель вкладок: переключение между дашбордами.
- Панель селекторов: фильтрация данных
- Боковое меню – быстрый доступ к т.д. основным модулям.
- Хлебные крошки (Breadcrumbs) возле таблиц - Возможность экспорта
- Наведение курсора на график - получение точечных данных

## Цели проекта

Проект выполнен в рамках комплексной практики по BI/DWH: работа включала полный цикл от сбора требований до визуализации.
